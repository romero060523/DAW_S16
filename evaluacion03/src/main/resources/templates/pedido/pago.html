<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
  <head>
    <th:block th:replace="~{fragments/head :: head}"></th:block>
    <title>Pagar Pedido #<span th:text="${pedido.id}">1</span></title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
      }

      .payment-container {
        max-width: 600px;
        margin: 3rem auto;
        padding: 0 1rem;
      }

      .payment-card {
        background: white;
        border-radius: 24px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .payment-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2.5rem;
        text-align: center;
      }

      .payment-header h1 {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        margin: 0 0 0.5rem 0;
      }

      .payment-header .amount {
        font-size: 3rem;
        font-weight: 700;
        margin: 1rem 0;
      }

      .payment-header small {
        opacity: 0.9;
        font-size: 1rem;
      }

      .payment-body {
        padding: 2.5rem;
      }

      .order-summary {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .order-summary h3 {
        font-family: "Playfair Display", serif;
        color: #333;
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .order-summary h3 i {
        color: #667eea;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px dashed #ddd;
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-total {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0 0 0;
        margin-top: 1rem;
        border-top: 2px solid #667eea;
        font-weight: 700;
        font-size: 1.2rem;
        color: #667eea;
      }

      /* Stripe Elements Container */
      .stripe-form {
        margin-top: 2rem;
      }

      .stripe-form label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }

      #payment-element {
        padding: 1rem;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        min-height: 150px;
      }

      #payment-message {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 1rem;
        text-align: center;
        display: none;
      }

      #payment-message.show {
        display: block;
      }

      .btn-pay {
        width: 100%;
        padding: 1.25rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        letter-spacing: 0.5px;
      }

      .btn-pay:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
      }

      .btn-pay:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .btn-pay .spinner {
        display: none;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      .btn-pay.loading .spinner {
        display: inline-block;
      }

      .btn-pay.loading .btn-text {
        display: none;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .btn-back {
        display: block;
        text-align: center;
        margin-top: 1.5rem;
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-back:hover {
        color: #764ba2;
      }

      .secure-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
        color: #6c757d;
        font-size: 0.85rem;
      }

      .secure-badge i {
        color: #28a745;
      }

      /* Íconos de tarjetas aceptadas */
      .accepted-cards {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        opacity: 0.7;
      }

      .accepted-cards i {
        font-size: 2rem;
        color: #333;
      }

      @media (max-width: 576px) {
        .payment-header h1 {
          font-size: 1.5rem;
        }
        .payment-header .amount {
          font-size: 2.5rem;
        }
        .payment-body {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="payment-container">
      <div class="payment-card">
        <!-- Header -->
        <div class="payment-header">
          <i class="bi bi-credit-card-2-front" style="font-size: 2.5rem;"></i>
          <h1>Pagar Pedido</h1>
          <small>Pedido #<span th:text="${pedido.id}">1</span></small>
          <div class="amount" th:text="'S/ ' + ${#numbers.formatDecimal(totalConIgv, 1, 2)}">S/ 120.00</div>
          <small>(Incluye IGV 18%)</small>
        </div>

        <!-- Body -->
        <div class="payment-body">
          <!-- Resumen del Pedido -->
          <div class="order-summary">
            <h3><i class="bi bi-receipt"></i> Resumen del Pedido</h3>
            <div class="order-item" th:each="d : ${pedido.detalles}">
              <span>
                <strong th:text="${d.cantidad}">1</strong>x 
                <span th:text="${d.plato.nombre}">Lomo Saltado</span>
              </span>
              <span th:text="'S/ ' + ${#numbers.formatDecimal(d.subtotal, 1, 2)}">S/ 25.00</span>
            </div>
            <div class="order-item">
              <span>Subtotal</span>
              <span th:text="'S/ ' + ${#numbers.formatDecimal(pedido.total, 1, 2)}">S/ 101.69</span>
            </div>
            <div class="order-item">
              <span>IGV (18%)</span>
              <span th:text="'S/ ' + ${#numbers.formatDecimal(pedido.total * 0.18, 1, 2)}">S/ 18.31</span>
            </div>
            <div class="order-total">
              <span>TOTAL A PAGAR</span>
              <span th:text="'S/ ' + ${#numbers.formatDecimal(totalConIgv, 1, 2)}">S/ 120.00</span>
            </div>
          </div>

          <!-- Formulario de Stripe -->
          <form id="payment-form" class="stripe-form">
            <label>Datos de la Tarjeta</label>
            <div id="payment-element"></div>
            <div id="payment-message"></div>
            <button id="submit" type="submit" class="btn-pay">
              <div class="spinner"></div>
              <span class="btn-text">
                <i class="bi bi-lock-fill"></i>
                Pagar S/ <span th:text="${#numbers.formatDecimal(totalConIgv, 1, 2)}">120.00</span>
              </span>
            </button>
          </form>

          <a th:href="@{/pedido/servidos}" class="btn-back">
            <i class="bi bi-arrow-left"></i> Volver sin pagar
          </a>

          <div class="secure-badge">
            <i class="bi bi-shield-check"></i>
            Pago seguro con Stripe
          </div>

          <div class="accepted-cards">
            <i class="bi bi-credit-card-2-front"></i>
            <span>Visa</span>
            <span>Mastercard</span>
            <span>Amex</span>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      const stripe = Stripe(/*[[${stripePublicKey}]]*/ 'pk_test_...');
      const clientSecret = /*[[${clientSecret}]]*/ '';
      const pedidoId = /*[[${pedido.id}]]*/ 0;

      let elements;

      initialize();

      async function initialize() {
        elements = stripe.elements({ clientSecret });

        const paymentElementOptions = {
          layout: "tabs",
        };

        const paymentElement = elements.create("payment", paymentElementOptions);
        paymentElement.mount("#payment-element");
      }

      document.querySelector("#payment-form").addEventListener("submit", handleSubmit);

      async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);

        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: window.location.origin + "/pedido/" + pedidoId + "/pago-exitoso",
          },
        });

        if (error) {
          if (error.type === "card_error" || error.type === "validation_error") {
            showMessage(error.message);
          } else {
            showMessage("Ocurrió un error inesperado.");
          }
        }

        setLoading(false);
      }

      function showMessage(messageText) {
        const messageContainer = document.querySelector("#payment-message");
        messageContainer.classList.add("show");
        messageContainer.textContent = messageText;

        setTimeout(function () {
          messageContainer.classList.remove("show");
          messageContainer.textContent = "";
        }, 5000);
      }

      function setLoading(isLoading) {
        const button = document.querySelector("#submit");
        if (isLoading) {
          button.disabled = true;
          button.classList.add("loading");
        } else {
          button.disabled = false;
          button.classList.remove("loading");
        }
      }
    </script>
  </body>
</html>
